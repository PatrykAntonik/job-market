name: Quality gates

on:
  workflow_call:
    inputs:
      python-version:
        type: string
        required: false
        default: "3.12"
      docker-target:
        type: string
        required: true
      image-name:
        type: string
        required: true
      cache-scope:
        type: string
        required: false
        default: "ci"

jobs:
  quality-gates:
    name: Lint, test, container health
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: jobmarket
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d jobmarket"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/jobmarket?sslmode=disable
      DOCKER_BUILDKIT: 1
      DOCKER_BUILDKIT_PROGRESS: plain
      COMPOSE_DOCKER_CLI_BUILD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Ensure pipx
        run: python -m pip install --upgrade pip pipx

      - name: Install Poetry
        run: pipx install poetry

      - name: Configure Poetry venv
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Check formatting (black)
        run: poetry run black JobMarket2 JobApp --check

      - name: Check import sorting (isort)
        run: poetry run isort -c JobApp JobMarket2

      - name: Check lint (pylint)
        run: poetry run pylint --fail-under=8.0 JobApp JobMarket2

      - name: Run tests (pytest)
        run: poetry run pytest -n auto --cov=JobApp --cov=JobMarket2 --cov-report=xml:coverage.xml

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-report
          path: coverage.xml

      - name: Setup docker buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build image (local)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          load: true
          target: ${{ inputs.docker-target }}
          tags: |
            ${{ inputs.image-name }}:ci
          cache-from: type=gha,scope=${{ inputs.cache-scope }}
          cache-to: type=gha,mode=max,scope=${{ inputs.cache-scope }}

      - name: Run container
        run: |
          docker run -d \
            --name ${{ inputs.image-name }} \
            --network host \
            --health-cmd "curl -f http://localhost:8080/health/" \
            --health-interval 5s \
            --health-timeout 3s \
            --health-retries 5 \
            -e "DATABASE_URL=${{ env.DATABASE_URL }}" \
            -e "DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1" \
            ${{ inputs.image-name }}:ci

      - name: Check container health
        run: |
          for i in {1..15}; do
            STATUS=$(docker inspect --format='{{json .State.Health.Status}}' ${{ inputs.image-name }})
            if [ "$STATUS" = "\"healthy\"" ]; then
              exit 0
            fi
            sleep 3
          done
          echo "API failed to start"
          docker logs ${{ inputs.image-name }}
          exit 1

      - name: Stop container
        if: always()
        run: docker rm -f ${{ inputs.image-name }}
