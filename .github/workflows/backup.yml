name: Backup repo
on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch: {}
permissions:
  contents: read
concurrency:
  group: backup-git-bundle
  cancel-in-progress: true
jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
      - name: Create git bundle (all branches + tags)
        run: |
          set -euo pipefail
          ts="$(date -u +%Y-%m-%d)"
          repo="${GITHUB_REPOSITORY#*/}"
          bundle="${repo}-${ts}.bundle"
          git bundle create "$bundle" --all
          git bundle verify "$bundle"
          echo "BUNDLE=$bundle" >> "$GITHUB_ENV"

      - name: Upload bundle as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: git-bundle
          path: ${{ env.BUNDLE }}
          retention-days: 90
